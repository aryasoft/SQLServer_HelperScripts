with target_data_cte as
(
    select  
        target_data = convert(xml, st.target_data)
    from
        sys.dm_xe_sessions s
        inner join sys.dm_xe_session_targets st on s.address = st.event_session_address
    where
        s.name = 'alwayson_health'
        and st.target_name = 'event_file'
),
full_path_cte as
(
    select
        full_path =
        target_data.value('(EventFileTarget/File/@name)[1]', 'varchar(1024)')
    from
        target_data_cte
)
, state_change_data as
(
    select  
        trf.object_name,
        event_data = convert(xml, trf.event_data)
    from
        full_path_cte
        cross apply sys.fn_xe_file_target_read_file(left(full_path, len(full_path) - charindex('\', reverse(full_path))) +'\AlwaysOn_health*.xel', null, null, null) trf
)
 
select
    event_timestamp =
        dateadd(hour, datediff(hour, getutcdate(), getdate()), event_data.value('(event/@timestamp)[1]', 'datetime')),
    ag_name =
        event_data.value('(event/data[@name = "availability_group_name"]/value)[1]', 'varchar(64)'),
    previous_state =
        event_data.value('(event/data[@name = "previous_state"]/text)[1]', 'varchar(64)'),
    current_state =
        event_data.value('(event/data[@name = "current_state"]/text)[1]', 'varchar(64)'),
    replica_server_name =  
        event_data.value('(event/data[@name = "availability_replica_name"]/value)[1]', 'varchar(64)')
from state_change_data
where object_name = 'availability_replica_state_change'
